import csv
import random

class It:
    def __init__(self, li):
        self.li = li
        self.index = 0
        
    def __iter__(self):
        return self

    def __next__(self):
        if self.index < len(self.li):
            result = self.li[self.index]
            self.index += 1
            return result
        else:
            raise StopIteration

books = []
login_dict = {}
basket_dict = {}
order_history = {}
no_account = False
login = False
account_no_r = 101
account_no_u = 201

with open("books.csv", mode='r', newline='') as csv_file:
    reader = csv.DictReader(csv_file)
    for row in reader:
        books.append(row)

iterator = It(books)

while not (login or no_account):
    
    try:
        login_choice = int(input("\nRegister: 0\nLogin: 1\nContinue without account: 2\n"))
        if login_choice == 0:
        
            #account_no = random.randint(1, 100)
            print("Welcome to the registration page!")
            username_input = input("\nPlease enter a username:\n")
            password_input = input("\nPlease enter a password:\n")
            first_name = input("\nPlease enter your first name:\n")
            last_name = input("\nPlease enter your last name:\n")
            #login_dict[username_input] = [password_input, first_name, last_name]
            login_dict[account_no_r] = [username_input, password_input, first_name, last_name]
            basket_dict[account_no_r] = []
            order_history[account_no_r] = []
            #account_no = random.randint(1, 100)
            account_no += 1
            print("Registration successful!")
            login = False

        elif login_choice == 1:
            print("Welcome to the login page!")
            username_input = input("\nPlease enter a username:\n")
            password_input = input("\nPlease enter a password:\n")

            for key, value in login_dict.items():
                if username_input == value[0] and password_input == value[1]:
                    print('--------------------------')
                    print('Login successful')
                    print("Welcome to the bookstore")
                    #print(f"Your account number is {key}.")
                    print('--------------------------')
                    login = True
                    break

            if not login:
                print("\nYour username or password was incorrect, please try again or register a new account:\n")
                login = False

        elif login_choice == 2:
            unregistered_basket = []
            print("\nContinuing with no account")
            no_account = True

        else:
            print("Invalid choice. Please select 0, 1, or 2.")

    except ValueError:
        print("Invalid input. Please enter a valid integer choice.")

    while login:
        print(f"Your account number is {account_no}.")
        login_choice = (input("\nView/modify login details: 0\nView all books/Add to basket: 1\nSearch books: 2\nView basket/checkout: 3\nView order history: 4\nLog out: 5\n"))
        
        while login_choice == '0':
            print('\nHere are your up to date login details:')
            print(f"\nUsername: {login_dict[key][0]}\nPassword: {login_dict[key][1]}\nFirst name: {login_dict[key][2]}\nLast name: {login_dict[key][3]}")
            ask_modify = int(input("\nModify username: Type 0\nModify password: Type 1\nModify firstname: Type 2\nModify lastname: Type 3\nSave changes and continue: 4\n"))
            if ask_modify == 4:
                #continue
                break
            else:
                modify_to = input("\nWhat would you like to change it to?\n")
                login_dict[key][ask_modify] = modify_to
        
        if login_choice == '1':
            for row in books:
                print(f"ISBN: {row['isbn']}, Title: {row['title']}, Author: {row['author']}, Description: {row['description']}")
            
            isbn_input = (input("\nAdd book to basket: Enter isbn code\nContinue: Hit Enter\n"))
            iterator = It(books)
            
            while True:
                try:
                    book = next(iterator)
                    if book['isbn']==isbn_input:
                        basket_dict[key].append((book['isbn'], book['title'], book['author']))
                        print('Book added to basket\n')
                        print("Basket:")
                        for item in basket_dict[key]:
                            print(f"ISBN: {item[0]} Title: {item[1]}")
                except StopIteration:
                    break

        if login_choice == '2':
            search = input("\nPlease enter the title of the book:\n")
            print("\nResults:")
            iterator = It(books)

            while True:
                try:
                    book = next(iterator) #Get the next book.
                    if search.lower() in book['title'].lower(): #When the user's search matches a book title, print out its information.
                        print(f"ISBN: {book['isbn']}, Title: {book['title']}, Author: {book['author']}, Description: {book['description']}")
                        found = True #Set found to True so that it doesn't print out "book not found".
                except StopIteration: #If there are no more books, stop the iteration (logic written in It class).
                    if not found:
                        print("Book not found")
                    break #Break out of the while loop.
                    
            isbn_input = (input("\nAdd book to basket: Enter isbn code\nContinue: Hit Enter\n"))
            iterator = It(books)
            
            while True:
                try:
                    book = next(iterator)
                    if book['isbn']==isbn_input:
                        basket_dict[key].append((book['isbn'], book['title'], book['author']))
                        print('Book added to basket\n')
                        print("Basket:")
                        for item in basket_dict[key]:
                            print(f"ISBN: {item[0]} Title: {item[1]}")
                except StopIteration:
                    break

        if login_choice == '3':
            print(basket_dict[key])
            if basket_dict:
                print('--------------------------')
                print("\nShopping Basket:")
                for item in basket_dict[key]:
                    print(f"ISBN: {item[0]} Title: {item[1]}")
                print('--------------------------')
            
            basket_option = input("\nModify your basket: Type 'm':\nProceed to checkout: Type 'c'\nReturn to menu: Hit 'Enter\n")

            if basket_option == 'c':
                order_history[key].append(basket_dict[key][:])
                basket_dict[key].clear()
                print("\nPurchase successful!.\n")
            
            if basket_option == 'm':
                remove = input("\nTo remove an item: Type its ISBN code\nTo clear basket: type 'all'\n")
                
                if remove == 'all':
                    basket_dict[key].clear()
                
                
                for item in basket_dict[key]:
                    if remove == item[0]:
                        basket_dict[key].remove(item)
                        
        if login_choice == '4':
            print('\n--------------------------')
            print("Order history (isbn,title,author):")
            for item in order_history[key]:
                print(item)
            print('--------------------------\n')

        if login_choice == '5':
            login = False
#--------------------------------------------------------------------------------------------------------------------------------------------
    while no_account:

        unregistered_choice = (input("\nView all books: 0\nSearch books: 1\nView basket/checkout: 2\n"))
        
        if unregistered_choice == '0':
        
            for row in books:
                print(f"ISBN: {row['isbn']}, Title: {row['title']}, Author: {row['author']}, Description: {row['description']}")
            
            isbn_input = (input("\nAdd book to basket: Enter isbn code\nContinue: Hit Enter\n"))
            iterator = It(books)
            
            while True:
                try:
                    book = next(iterator)
                    if book['isbn']==isbn_input:
                        unregistered_basket.append((book['isbn'], book['title'], book['author']))
                        print('Book added to basket\n')
                        print("Basket:")
                        for item in unregistered_basket:
                            print(f"ISBN: {item[0]} Title: {item[1]}")
                except StopIteration:
                    break
        
        if unregistered_choice == '1':
        
            search = input("\nPlease enter the title of the book:\n")
            print("\nResults:")
            iterator = It(books)

            while True:
                try:
                    book = next(iterator) #Get the next book.
                    if search.lower() in book['title'].lower(): #When the user's search matches a book title, print out its information.
                        print(f"ISBN: {book['isbn']}, Title: {book['title']}, Author: {book['author']}, Description: {book['description']}")
                        found = True #Set found to True so that it doesn't print out "book not found".
                        
                except StopIteration: #If there are no more books, stop the iteration (logic written in It class).
                    if not found:
                        print("Book not found")
                    break #Break out of the while loop.
                    
            isbn_input = (input("\nAdd book to basket: Enter isbn code\nContinue: Hit Enter\n"))
            iterator = It(books)
            
            while True:
                try:
                    book = next(iterator)
                    if book['isbn']==isbn_input:
                        unregistered_basket.append((book['isbn'], book['title'], book['author']))
                        print('Book added to basket\n')
                        print("Basket:")
                        for item in unregistered_basket:
                            print(f"ISBN: {item[0]} Title: {item[1]}")
                except StopIteration:
                    break
        
        if unregistered_choice == '2':
            if unregistered_basket:
                print('--------------------------')
                print("\nShopping Basket:")
                for item in unregistered_basket:
                    print(f"ISBN: {item[0]} Title: {item[1]}")
                print('--------------------------')
            
                basket_option = input("\nModify your basket: Type 'm':\nProceed to checkout: Type 'c'\nReturn to menu: Hit 'Enter\n")
                
                if basket_option == 'c':
                    checkout_choice = print('\nLogin and proceed to checkout: 0\nCreate account and proceed to checkout: 1\n')
                    
                    if checkout_choice == 0:
                        username_input = input("\nPlease enter a username:\n")
                        password_input = input("\nPlease enter a password:\n")

                        for key, value in login_dict.items():
                            if username_input == value[0] and password_input == value[1]:
                                print('--------------------------')
                                print('Login successful')
                                print("Welcome to the bookstore")
                                #print(f"Your account number is {key}.")
                                print('--------------------------')
                                #login = True
                                break

                    if basket_option == '1':
                        #print("\nYour username or password was incorrect, please try again or register a new account:\n")
                        #login = False
                          
                        username_input = input("\nPlease enter a username:\n")
                        password_input = input("\nPlease enter a password:\n")
                        first_name = input("\nPlease enter your first name:\n")
                        last_name = input("\nPlease enter your last name:\n")

                        #login_dict[username_input] = [password_input, first_name, last_name]
                        #account_no = account_no = random.randint(1, 100)
                        login_dict[account_no_u] = [username_input, password_input, first_name, last_name]
                        basket_dict[account_no_u] = unregistered_basket
                        order_history[account_no_u].append(unregistered_basket)
                        account_no_u += 1
                        #login = True
                
                
        if unregistered_choice == '3':
            no_account = False


